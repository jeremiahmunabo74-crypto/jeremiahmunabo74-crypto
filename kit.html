<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>KitOS Desktop with Apps (C/WASM, Notes, Calculator)</title>
  <style>
    html, body {
      height: 100%; margin: 0; padding: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    body {
      background: linear-gradient(120deg, #1e3a5c 0%, #74b9ff 100%);
      width: 100vw; height: 100vh; overflow: hidden;
    }
    #desktop {
      width: 100vw; height: 100vh; position: relative;
    }
    .desktop-icon {
      position: absolute;
      width: 80px; text-align: center; color: #fff; cursor: pointer;
      user-select: none;
    }
    .desktop-icon img {
      width: 56px; height: 56px; margin-bottom: 5px;
      filter: drop-shadow(0 2px 8px #0006);
    }
    .desktop-icon span {
      font-size: 15px; text-shadow: 0 1px 5px #000a;
      background: rgba(30,42,60,0.5); padding: 2px 10px; border-radius: 8px;
      display: inline-block;
    }
    .window {
      position: absolute;
      top: 80px; left: 80px;
      min-width: 320px; min-height: 160px; max-width: 96vw;
      background: #f5f6fa;
      border: 2px solid #353b48;
      border-radius: 7px;
      box-shadow: 0 6px 32px rgba(44,62,80,0.25);
      z-index: 99;
      display: flex; flex-direction: column;
      animation: popin 0.2s;
    }
    @keyframes popin { from { transform: scale(0.85); opacity: 0;} to { transform: scale(1); opacity: 1;} }
    .window-header {
      background: #40739e;
      color: #fff; font-weight: bold;
      padding: 10px 12px; border-radius: 7px 7px 0 0;
      display: flex; justify-content: space-between; align-items: center;
      user-select: none; cursor: move;
    }
    .window-close {
      background: #e84118; color: #fff; border: none;
      width: 24px; height: 24px; border-radius: 50%;
      font-size: 17px; font-weight: bold; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      margin-left: 8px; transition: background 0.18s;
    }
    .window-close:hover { background: #c23616; }
    .window-content {
      padding: 20px; flex: 1; background: #f5f6fa; border-radius: 0 0 7px 7px;
      overflow: auto; font-size: 17px;
    }
    .footer {
      position: absolute; bottom: 12px; right: 20px; color: #fff9; font-size: 14px;
    }
    @media (max-width: 600px) {
      .window { min-width: 90vw; }
    }
  </style>
</head>
<body>
  <div id="desktop">
    <div class="desktop-icon" id="icon-wasm" style="top:80px;left:80px;">
      <img src="https://img.icons8.com/ios-filled/100/ffffff/calculator.png" alt="WASM App"/>
      <span>Add (C/WASM)</span>
    </div>
    <div class="desktop-icon" id="icon-notes" style="top:180px;left:80px;">
      <img src="https://img.icons8.com/ios-filled/100/ffffff/note.png" alt="Notes"/>
      <span>Notes</span>
    </div>
    <div class="desktop-icon" id="icon-calc" style="top:280px;left:80px;">
      <img src="https://img.icons8.com/ios-glyphs/100/ffffff/calculator.png" alt="Calculator"/>
      <span>Calculator</span>
    </div>
  </div>
  <div class="footer">KitOS Desktop Demo &mdash; C/WASM + Apps</div>
  <script src="main.js"></script>
  <script>
    let openWindows = {};
    let zCounter = 100;

    function makeWindow(appId, html, x=160, y=120) {
      if (openWindows[appId]) {
        bringToFront(openWindows[appId]);
        return;
      }
      const win = document.createElement("div");
      win.className = "window";
      win.style.left = x+"px";
      win.style.top = y+"px";
      win.innerHTML = html;
      document.getElementById("desktop").appendChild(win);
      openWindows[appId] = win;
      bringToFront(win);

      // Close handler
      win.querySelector(".window-close").onclick = function() {
        win.remove();
        delete openWindows[appId];
      };
      // Draggable
      let isDrag = false, dx=0, dy=0;
      const header = win.querySelector(".window-header");
      header.onmousedown = function(e) {
        isDrag = true; dx = e.clientX - win.offsetLeft; dy = e.clientY - win.offsetTop;
        bringToFront(win);
        document.onmousemove = function(e) {
          if (isDrag) {
            win.style.left = (e.clientX - dx) + "px";
            win.style.top = (e.clientY - dy) + "px";
          }
        }
        document.onmouseup = function(){ isDrag = false; document.onmousemove = null; }
      };
      return win;
    }

    function bringToFront(win) {
      zCounter++;
      win.style.zIndex = zCounter;
    }

    // WASM Add App
    document.getElementById("icon-wasm").onclick = function() {
      let html = `
        <div class="window-header">Add (C/WASM) <button class="window-close" title="Close">&times;</button></div>
        <div class="window-content">
          <b>Add two numbers using C (WebAssembly):</b><br><br>
          <input type="number" id="a" value="2" style="width:60px;"> +
          <input type="number" id="b" value="3" style="width:60px;">
          <button id="addBtn" style="margin-left:10px;">Add (C/WASM)</button>
          <div style="margin-top:15px;">Result: <span id="result">?</span></div>
          <div style="font-size:13px;color:#888;margin-top:18px;">C code:<br>
            <pre style="background:#222;color:#0f0;padding:7px;border-radius:6px;margin:0;font-size:13px;overflow-x:auto;">
#include &lt;emscripten.h&gt;

EMSCRIPTEN_KEEPALIVE
int add(int a, int b) {
    return a + b;
}
            </pre>
          </div>
        </div>
      `;
      const win = makeWindow("wasm", html, 200, 120);

      if (!window.createModule) return; // Wait for script to load
      window.createModule().then(Module => {
        const add = Module.cwrap('add', 'number', ['number', 'number']);
        win.querySelector("#addBtn").onclick = function() {
          const a = parseInt(win.querySelector("#a").value, 10);
          const b = parseInt(win.querySelector("#b").value, 10);
          const result = add(a, b);
          win.querySelector("#result").textContent = result;
        };
      });
    };

    // Notes App
    document.getElementById("icon-notes").onclick = function() {
      let html = `
        <div class="window-header">Notes <button class="window-close" title="Close">&times;</button></div>
        <div class="window-content">
          <textarea style="width:99%;height:120px;font-size:17px;">Welcome to KitOS Notes!
Type your notes here.</textarea>
        </div>
      `;
      makeWindow("notes", html, 340, 180);
    };

    // Calculator App
    document.getElementById("icon-calc").onclick = function() {
      let html = `
        <div class="window-header">Calculator <button class="window-close" title="Close">&times;</button></div>
        <div class="window-content" id="calc-body">
          <input id="calc-display" type="text" style="width:95%;font-size:20px;text-align:right;margin-bottom:8px;" readonly value="0" /><br/>
          <div>
            <button onclick="calcType('7')">7</button>
            <button onclick="calcType('8')">8</button>
            <button onclick="calcType('9')">9</button>
            <button onclick="calcType('/')">/</button>
          </div>
          <div>
            <button onclick="calcType('4')">4</button>
            <button onclick="calcType('5')">5</button>
            <button onclick="calcType('6')">6</button>
            <button onclick="calcType('*')">*</button>
          </div>
          <div>
            <button onclick="calcType('1')">1</button>
            <button onclick="calcType('2')">2</button>
            <button onclick="calcType('3')">3</button>
            <button onclick="calcType('-')">-</button>
          </div>
          <div>
            <button onclick="calcType('0')">0</button>
            <button onclick="calcType('.')">.</button>
            <button onclick="calcEquals()">=</button>
            <button onclick="calcType('+')">+</button>
          </div>
          <div>
            <button onclick="calcClear()" style="width:90%">C</button>
          </div>
        </div>
      `;
      const win = makeWindow("calc", html, 500, 250);
      // Calculator logic for this window
      const display = win.querySelector("#calc-display");
      win.calcValue = "";
      win.calcType = function(val) {
        if (display.value === "0" && val !== ".") display.value = "";
        display.value += val;
      };
      win.calcEquals = function() {
        try {
          display.value = eval(display.value) || "0";
        } catch { display.value = "Err"; }
      };
      win.calcClear = function() { display.value = "0"; };
      win.querySelectorAll("button").forEach(btn => {
        const txt = btn.textContent;
        if (txt >= "0" && txt <= "9" || txt === "." || txt === "+" || txt === "-" || txt === "*" || txt === "/") {
          btn.onclick = () => win.calcType(txt);
        } else if (txt === "=") {
          btn.onclick = win.calcEquals;
        } else if (txt === "C") {
          btn.onclick = win.calcClear;
        }
      });
    };
  </script>
</body>
</html>
